<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO BLE</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{
    --pad:10px;
    --uiScale: 1;
    --headerH: 64px;
    --btnH: 36px;
    --gap: 8px;
    --headerBgTop: #fff7ed;
    --headerBgBottom: #fffbeb;
    --headerBorder: #fed7aa;
    --logH: 180px;
    --blue: #1d4ed8;

    --handleWBase: 22;
    --handleHBase: 28;
    --triWBase:   14;
    --triHBase:   12;

    --handleW: calc(var(--handleWBase) * var(--uiScale) * 1px);
    --handleH: calc(var(--handleHBase) * var(--uiScale) * 1px);
    --triW:    calc(var(--triWBase)    * var(--uiScale) * 1px);
    --triH:    calc(var(--triHBase)    * var(--uiScale) * 1px);
    --linkBar: calc(3 * var(--uiScale) * 1px);

    --keyW: clamp(52px, 8vmin, 92px);
    --keyH: calc(var(--keyW) * 2.7);
    --keyGap: 6px;
    --keyFont: 14px;
  }
  @media (max-width: 480px){
    :root{ --keyGap: 4px; --keyFont: 13px; }
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{ margin:0; font-family:system-ui, sans-serif; background:#fff; }

  /* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header{
    padding: 8px 12px;
    background: linear-gradient(180deg, var(--headerBgTop), var(--headerBgBottom));
    border-bottom: 1px solid var(--headerBorder);
    position:relative; z-index:10;
  }
  #topbar{
    display:flex; align-items:center; gap: calc(var(--gap) * var(--uiScale));
    flex-wrap: wrap;
  }
  .title{
    font-weight: 800; letter-spacing: .2px;
    color:#7c2d12; margin-right: 12px;
    font-size: calc(18px * var(--uiScale));
  }
  .spacer{ flex: 1 1 auto; }

  .btn{
    height: calc(var(--btnH) * var(--uiScale));
    padding: 0 calc(12px * var(--uiScale));
    border:0; border-radius: calc(10px * var(--uiScale));
    display:inline-flex; align-items:center; justify-content:center;
    font-size: calc(14px * var(--uiScale)); font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    background:#f3f4f6; color:#111827; cursor:pointer;
    user-select:none;
  }
  .btn.small{
    height: calc(var(--btnH) * var(--uiScale) * .85);
    padding: 0 calc(10px * var(--uiScale));
    font-size: calc(12px * var(--uiScale));
  }
  #connectToggle{ background:#2563eb; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }

  .state{
    display:inline-flex; align-items:center; gap:calc(6px * var(--uiScale));
    height: calc(var(--btnH) * var(--uiScale));
    padding: 0 calc(6px * var(--uiScale));
    font-size: calc(12px * var(--uiScale));
  }
  .badgeDot{
    width: calc(22px * var(--uiScale));
    height: calc(22px * var(--uiScale));
    border-radius: 50%;
    display:inline-flex; align-items:center; justify-content:center;
    font-size: calc(11px * var(--uiScale));
    font-weight:800; color:#fff;
    box-shadow: 0 0 0 calc(4px * var(--uiScale)) rgba(0,0,0,.06) inset;
  }
  .badgeDot.on{ background:#3b82f6; }
  .badgeDot.off{ background:#ef4444; }

  /* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main{ display:flex; width:100%; height: calc(100vh - var(--headerH)); }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; overflow:visible; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }

  #right{
    flex:0 0 40%; display:flex; flex-direction:column; background:#fff;
    margin:8px 8px 8px 0; border:1px solid #e5e7eb; border-left:3px solid var(--blue);
    border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden;
    position:relative;
  }

  /* â”€â”€ ìš°ì¸¡ ìƒë‹¨: ì¹´ë©”ë¼ í”„ë¦¬ë·° â”€â”€ */
  #rightTop{
    flex:1 1 auto; border-bottom:1px solid #e5e7eb; min-height: 120px;
    background:#0b0f14; color:#fff;
    display:flex; align-items:center; justify-content:center;
    padding: 0; overflow:hidden;
  }
  .camWrap{
    position:relative; width:100%; height:100%;
    display:flex; align-items:center; justify-content:center; background:#000;
  }
  #camVideo{
    width:100%; height:100%; object-fit:cover; transform: scaleX(-1); /* ì „ë©´ ì¹´ë©”ë¼ ê±°ìš¸ íš¨ê³¼ */
    background:#000;
  }
  .camUi{
    position:absolute; right:12px; top:12px; display:flex; gap:8px; align-items:center; z-index:2;
  }
  .camBadge{
    font: 700 12px/1 system-ui; color:#fff;
    padding:.35rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,.3);
    background:rgba(0,0,0,.35); backdrop-filter: blur(6px)
  }
  /* ì›€ì§ì„ ì´ˆì  ë°•ìŠ¤ */
  #focusBox{
    position:absolute; left:50%; top:50%;
    width:22%; aspect-ratio:1/1;
    transform: translate(-50%,-50%);
    border:2px solid rgba(255,255,255,.9);
    border-radius:10px;
    box-shadow:0 0 0 2px rgba(0,0,0,.25), 0 0 18px rgba(0,255,220,.35);
    pointer-events:none; z-index:2; opacity:.15; transition: opacity .2s linear;
  }
  /* â˜… ì¶”ê°€: ìƒ‰ìƒ ì½ê¸° í‘œì‹œ (ìº  í™”ë©´ ì•„ë˜ìª½ ì¤‘ì•™) */
  #colorReadout{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:12px; z-index:2; display:inline-flex; align-items:center; gap:.55rem;
    font: 800 13px/1 system-ui; color:#fff;
    padding:.48rem .8rem; border-radius:999px; border:1px solid rgba(255,255,255,.35);
    background:rgba(0,0,0,.35); backdrop-filter: blur(6px);
  }
  #colorReadout .dot{
    width:1em; height:1em; border-radius:50%; box-shadow:0 0 0 2px rgba(255,255,255,.25) inset;
  }

  /* ë¦¬ì‚¬ì´ì € ë°” */
  #rightDivider{
    flex:0 0 6px; cursor: row-resize;
    background: repeating-linear-gradient(90deg, #d1d5db 0, #d1d5db 6px, #e5e7eb 6px, #e5e7eb 12px);
  }

  /* ë¡œê·¸ íŒ¨ë„ */
  #rightBottom{
    flex: 0 0 var(--logH);
    display:flex; flex-direction:column; min-height:0; overflow:hidden;
    padding: calc(10px * var(--uiScale));
    background:#0b0f14; color:#d1e4ff; border-top:1px solid #1f2937;
  }
  #log{
    flex:1 1 0; min-height:0; overflow:auto; white-space:pre-wrap;
    background:#0b0f14; border:1px solid #1f2937; border-radius: calc(8px * var(--uiScale));
    padding: calc(10px * var(--uiScale));
    font-family: ui-monospace, Menlo, Consolas, monospace;
    font-size: calc(12px * var(--uiScale)); color:#d1e4ff;
  }

  /* ì‹¤í–‰ì°½ í† ê¸€ í•¸ë“¤ */
  #panelHandle{
    position:absolute; top: calc(12px * var(--uiScale)); right: 0;
    z-index:9999; width: var(--handleW); height: var(--handleH);
    background: var(--blue); border: 0; border-radius: calc(6px * var(--uiScale));
    box-shadow: 0 2px 8px rgba(0,0,0,.18);
    cursor: pointer; padding: 0;
  }
  #panelHandle::before{
    content:''; position:absolute; top:0; right: calc(0px - var(--linkBar));
    width: var(--linkBar); height:100%; background: var(--blue);
    border-top-right-radius: calc(6px * var(--uiScale));
    border-bottom-right-radius: calc(6px * var(--uiScale));
  }
  #panelHandle::after{
    content:''; position:absolute; top:50%; transform: translateY(-50%);
    width:0; height:0; border-style: solid;
  }
  #panelHandle.open::after{
    left: calc((var(--handleW) - var(--triW)) / 2);
    border-width: var(--triH) 0 var(--triH) var(--triW);
    border-color: transparent transparent transparent white;
  }
  #panelHandle.closed::after{
    left: calc((var(--handleW) - var(--triW)) / 2);
    border-width: var(--triH) var(--triW) var(--triH) 0;
    border-color: transparent white transparent transparent;
  }

  .blocklyZoom,.blocklyTrash{ display:block !important; }
  .blocklyTrashLid, .blocklyTrashcanLid, .blocklyTrashCanLid { display:none !important; }

  body.fs-active #main{ height: calc(100vh - var(--headerH)); }
  body.panel-collapsed #right{ display:none; }
  body.panel-collapsed #left{ flex:1 1 100%; }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header id="appHeader">
    <div id="topbar">
      <div class="title">XROBO BLE</div>
      <div class="spacer"></div>

      <button id="saveBtn" class="btn" title="í”„ë¡œì íŠ¸ ì €ì¥">ì €ì¥</button>
      <button id="openBtn" class="btn" title="í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°">ë¶ˆëŸ¬ì˜¤ê¸°</button>

      <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
      <button id="connectToggle" class="btn">ì—°ê²°</button>
      <button id="runToggle" class="btn">â–¶ ì‹¤í–‰</button> <!-- â˜… ì‹¤í–‰í•´ë„ ì „ì²´í™”ë©´ ì—†ìŒ -->
      <button id="fsBtn" class="btn" title="ì „ì²´í™”ë©´">ì „ì²´í™”ë©´</button>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelHandle" class="open" title="ì‹¤í–‰ì°½ ë‹«ê¸°"></button>
    </div>

    <div id="right">
      <!-- ìš°ì¸¡ ìƒë‹¨: ì¹´ë©”ë¼ í”„ë¦¬ë·° -->
      <div id="rightTop">
        <div class="camWrap">
          <video id="camVideo" playsinline autoplay muted></video>
          <div id="focusBox"></div>
          <div class="camUi">
            <span id="camBadge" class="camBadge">Cam: off</span>
            <button id="camToggle" class="btn small">ìº  ì¼œê¸°</button>
          </div>
          <!-- â˜… ì¶”ê°€: ìƒ‰ìƒ í‘œì‹œ ë°” -->
          <div id="colorReadout"><span class="dot"></span><span class="label">ìƒ‰ì—†ìŒ</span></div>
        </div>
      </div>
      <div id="rightDivider" title="ë“œë˜ê·¸í•˜ì—¬ ë¡œê·¸ ë†’ì´ ì¡°ì ˆ"></div>
      <div id="rightBottom">
        <div style="font-size:calc(12px * var(--uiScale));color:#9ca3af;">ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- íˆ´ë°•ìŠ¤ -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
      <!-- â˜… ë“œë¡­ë‹¤ìš´ ìƒ‰ ì„ íƒ -->
      <block type="xrobo_start"></block>
    </category>

    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor12_dd">
        <field name="M1">20</field><field name="M2">20</field><field name="MS">500</field>
      </block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>
      <block type="melody">
        <field name="PITCH">C4</field>
        <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
        <value name="WAIT"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="led_ctrl">
        <field name="TGT">OUT1</field>
        <field name="MODE">BRIGHT</field>
        <field name="VAL">10</field>
      </block>
    </category>

    <category name="ì œì–´" colour="#10b981">
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
      </block>
      <block type="wait_seconds">
        <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
    </category>
  </xml>

<script>
/* ================= ì¹´ë©”ë¼: í”„ë¦¬ë·° + ìƒ‰ ê°ì§€ + ì›€ì§ì„ ì´ˆì  (ì´ì „ ì•Œê³ ë¦¬ì¦˜ ë³µì›) ================= */
const camVideo = $('camVideo');
const camToggle = $('camToggle');
const camBadge  = $('camBadge');
const focusBox  = $('focusBox');
const colorReadout = $('colorReadout');
const colorDot = colorReadout.querySelector('.dot');
const colorLabel = colorReadout.querySelector('.label');

let camStream = null, camOn = false, camRAF = null;

/* === íŒŒë¼ë¯¸í„° (ì´ì „ê°’ìœ¼ë¡œ ë³µì›) === */
const LOW_W = 64, LOW_H = 48;       // ì²˜ë¦¬ í•´ìƒë„
const DIFF_T = 22;                   // í”„ë ˆì„ ì°¨ ì„ê³„(ëª¨ì…˜ í”½ì…€)
const MASS_T = 14000;                // ëª¨ì…˜ ì´ëŸ‰ ì„ê³„(ì¶©ë¶„íˆ ì›€ì§ì¼ ë•Œë§Œ ìƒ‰ íŒì •)
const S_T = 0.25;                    // ì±„ë„ ì»·
const V_T = 0.18;                    // ëª…ë„ ì»·
const HOLD_MS = 280;                 // ìƒ‰ ë³€ê²½ ë””ë°”ìš´ìŠ¤
const CONF_MIN = 0.55;               // ìµœìƒìœ„ ìƒ‰ ë¹„ìœ¨ ìµœì†Œ ì‹ ë¢°ë„
const FOCUS_LERP = 0.20;             // ì´ˆì  ì´ë™ ìŠ¤ë¬´ë”©(ê·¸ëŒ€ë¡œ)

const NAME_KR = { RED:'ë¹¨ê°„ìƒ‰', ORG:'ì£¼í™©ìƒ‰', YEL:'ë…¸ë€ìƒ‰', GRN:'ì´ˆë¡ìƒ‰', BLU:'íŒŒë‘ìƒ‰', VIO:'ë³´ë¼ìƒ‰', NONE:'ìƒ‰ì—†ìŒ' };
const HUE_MAP = { RED:0, ORG:28, YEL:55, GRN:120, BLU:210, VIO:285 };

const procCvs = document.createElement('canvas');
const procCtx = procCvs.getContext('2d', { willReadFrequently:true });
procCvs.width = LOW_W; procCvs.height = LOW_H;

/* ìœ í‹¸: RGBâ†’HSV, Hueâ†’ì¹´í…Œê³ ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼) */
function rgb2hsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  const v=max, d=max-min;
  const s = max===0 ? 0 : d/max;
  let h=0;
  if(d!==0){
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      case b: h=(r-g)/d + 4; break;
    }
    h*=60;
  }
  return {h,s,v};
}
function hueToCat(h){
  if (h < 15 || h >= 345) return 'RED';
  if (h < 40)  return 'ORG';
  if (h < 70)  return 'YEL';
  if (h < 170) return 'GRN';
  if (h < 250) return 'BLU';
  return 'VIO';
}

/* UI ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
function updateCamUi(){
  camBadge.textContent = 'Cam: ' + (camOn ? 'on' : 'off');
  camToggle.textContent = camOn ? 'ìº  ë„ê¸°' : 'ìº  ì¼œê¸°';
}
function updateColorReadout(code){
  const name = NAME_KR[code] || 'ìƒ‰ì—†ìŒ';
  colorLabel.textContent = name;
  if (code && code !== 'NONE' && HUE_MAP[code] != null){
    colorDot.style.background = `hsl(${HUE_MAP[code]}, 85%, 55%)`;
  }else{
    colorDot.style.background = '#777';
  }
}

/* ìº  ON/OFF (ê¸°ì¡´ê³¼ ë™ì¼) */
async function startCam(){
  if(camOn) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:{ideal:'user'}, width:{ideal:320}, height:{ideal:240}, frameRate:{ideal:30,max:30} },
      audio: false
    });
    camStream = stream;
    camVideo.srcObject = stream;
    await camVideo.play();
    camOn = true; updateCamUi();
    startDetectLoop();
    log('ğŸ¥ ì¹´ë©”ë¼ ì¼œì§');
  }catch(e){ log('âŒ ì¹´ë©”ë¼ ì‹¤íŒ¨: '+e); }
}
function stopCam(){
  if(!camOn) return;
  try{ camVideo.pause(); }catch(_){}
  if(camVideo.srcObject){
    try{ camVideo.srcObject.getTracks().forEach(t=>t.stop()); }catch(_){}
    camVideo.srcObject = null;
  }
  camStream = null; camOn=false; updateCamUi();
  if(camRAF){ cancelAnimationFrame(camRAF); camRAF=null; }
  // ìƒíƒœ ë¦¬ì…‹
  activeColor='NONE'; candColor='NONE'; lastEventColor=null;
  updateColorReadout('NONE');
  focusBox.style.opacity='.15';
  focusBox.style.left='50%'; focusBox.style.top='50%';
  log('ğŸ›‘ ì¹´ë©”ë¼ êº¼ì§');
}
camToggle.onclick = ()=> camOn ? stopCam() : startCam();

/* ìƒ‰ ì•ˆì •í™”/ì´ë²¤íŠ¸ ìƒíƒœ (ë³€ê²½ ì—†ìŒ) */
let activeColor = 'NONE';   // í™”ë©´ì— í‘œì‹œì¤‘ì¸ í™•ì • ìƒ‰
let candColor   = 'NONE';   // í›„ë³´ ìƒ‰
let candSince   = 0;
let lastEventColor = null;  // ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ìƒ‰

/* === í•µì‹¬: ì´ì „ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë³µì›ëœ ê²€ì¶œ ë£¨í”„ === */
function startDetectLoop(){
  const step = ()=>{
    if(!camOn || camVideo.readyState < 2){ camRAF = requestAnimationFrame(step); return; }

    // 0) í”„ë ˆì„ ìº¡ì²˜
    procCtx.drawImage(camVideo, 0, 0, LOW_W, LOW_H);
    const img = procCtx.getImageData(0,0,LOW_W,LOW_H);
    const data = img.data;

    // 1) ê·¸ë ˆì´ì›”ë“œ(í™”ì´íŠ¸ë°¸ëŸ°ìŠ¤) ë³´ì • ê²Œì¸ ê³„ì‚° (í”„ë ˆì„ ì „ì²´ í‰ê· )
    let sumR=0,sumG=0,sumB=0;
    for(let p=0;p<data.length;p+=4){ sumR+=data[p]; sumG+=data[p+1]; sumB+=data[p+2]; }
    const nPix = LOW_W*LOW_H;
    const mR=sumR/nPix, mG=sumG/nPix, mB=sumB/nPix;
    const avg=(mR+mG+mB)/3 || 1;
    const gR = avg/(mR||1), gG = avg/(mG||1), gB = avg/(mB||1);

    // 2) ëª¨ì…˜ + ìƒ‰ ëˆ„ì  (ì´ì „ ë°©ì‹)
    if (!step.prevGray) step.prevGray = new Uint8ClampedArray(nPix);
    let mass=0, sxa=0, sya=0;
    const acc = { RED:0, ORG:0, YEL:0, GRN:0, BLU:0, VIO:0 };

    for(let y=0, i=0, p=0; y<LOW_H; y++){
      for(let x=0; x<LOW_W; x++, i++){
        const r0=data[p++], g0=data[p++], b0=data[p++]; p++; // a skip

        // ëª¨ì…˜ í”½ì…€ ì„ ë³„
        const gray = (r0*0.299 + g0*0.587 + b0*0.114)|0;
        const d = Math.abs(gray - step.prevGray[i]);
        step.prevGray[i] = gray;
        if (d > DIFF_T){
          // ëª¨ì…˜ ë¬´ê²Œì¤‘ì‹¬(ì´ˆì  ë°•ìŠ¤ìš©)
          sxa += x*d; sya += y*d; mass += d;

          // ìƒ‰ ì¶”ì •: í™”ë°¸ ë³´ì • â†’ HSV â†’ ì»·
          const r = Math.min(255, r0*gR);
          const g = Math.min(255, g0*gG);
          const b = Math.min(255, b0*gB);
          const {h,s,v} = rgb2hsv(r,g,b);
          if (s > S_T && v > V_T){
            // ê°€ì¤‘ì¹˜: ëª¨ì…˜ ê°•ë„ d Ã— ì±„ë„^1.3  (ì´ì „ê³¼ ë™ì¼)
            const w = d * Math.pow(s, 1.3);
            acc[hueToCat(h)] += w;
          }
        }
      }
    }

    // 3) ì›€ì§ì„ ì´ˆì  ë°•ìŠ¤ (ëª¨ì…˜ëŸ‰ ì¶©ë¶„í•  ë•Œë§Œ)
    if (mass > MASS_T){
      const cx = sxa / mass, cy = sya / mass;        // 0..LOW_W-1 / 0..LOW_H-1
      const fx = 1 - (cx / (LOW_W-1));               // ì „ë©´ì¹´ë©”ë¼ ê±°ìš¸ ë³´ì •
      const fy =      (cy / (LOW_H-1));
      const lerp = (a,b,t)=> a + (b-a)*t;
      const curL = parseFloat((focusBox.style.left||'50%'))/100 || .5;
      const curT = parseFloat((focusBox.style.top ||'50%'))/100 || .5;
      const nx = lerp(curL, fx, FOCUS_LERP);
      const ny = lerp(curT, fy, FOCUS_LERP);
      focusBox.style.left = (nx*100).toFixed(1)+'%';
      focusBox.style.top  = (ny*100).toFixed(1)+'%';
      focusBox.style.opacity = '1';
    }else{
      focusBox.style.opacity = '.15';
    }

    // 4) ìƒ‰ íŒì • (ëª¨ì…˜ëŸ‰ì´ ì¶©ë¶„í•  ë•Œë§Œ) â†’ ë””ë°”ìš´ìŠ¤ â†’ ë³€ê²½ì‹œì—ë§Œ ì´ë²¤íŠ¸
    const totalW = acc.RED+acc.ORG+acc.YEL+acc.GRN+acc.BLU+acc.VIO;
    let frameColor = 'NONE';
    if (mass > MASS_T && totalW > 0){
      let top='RED', topW=-1;
      for(const k in acc){ if(acc[k] > topW){ topW=acc[k]; top=k; } }
      const conf = topW / totalW;
      if (conf >= CONF_MIN) frameColor = top;    // ì•„ë‹ˆë©´ 'NONE'
    }

    const now = performance.now();
    if (candColor !== frameColor){ candColor = frameColor; candSince = now; }
    if ((now - candSince) >= HOLD_MS && activeColor !== frameColor){
      activeColor = frameColor;                  // í™•ì •
      updateColorReadout(activeColor);           // í•˜ë‹¨ í‘œì‹œ

      if (activeColor !== 'NONE' && lastEventColor !== activeColor){
        lastEventColor = activeColor;            // â€œë³€ê²½ì‹œì—ë§Œâ€ ì´ë²¤íŠ¸ ì‹¤í–‰
        log('ğŸ¯ ìƒ‰ ê°ì§€: ' + activeColor + ' (ì´ë²¤íŠ¸ ì‹¤í–‰)');
        triggerEvent(activeColor);
      }
      if (activeColor === 'NONE'){ log('â—½ ìƒ‰ì—†ìŒ'); }
    }

    camRAF = requestAnimationFrame(step);
  };
  camRAF = requestAnimationFrame(step);
}
</script>

</body>
</html>
